<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Projetos Eletricos v14 - Supabase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-customfonts/1.0.4/roboto-normal.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-color: #2c3e50; --secondary-color: #3498db; --background-color: #f4f7f9; --white: #fff; --text-color: #34495e; --border-color: #bdc3c7; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--background-color); }
        .container { max-width: 1200px; width: 100%; margin: 20px auto; background-color: var(--white); padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; }
        h1, h2, h3 { color: var(--primary-color); text-align: center; margin-bottom: 25px; }
        h2 { border-top: 1px solid #e0e0e0; padding-top: 25px; margin-top: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 600; color: var(--text-color); }
        input, select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        input[readonly] { background-color: #ecf0f1; cursor: not-allowed; }
        button { padding: 15px; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .button-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .button-container button { font-size: 1.2rem; }
        #report { margin-top: 30px; background-color: #ecf0f1; padding: 20px; border-radius: 5px; white-space: pre-wrap; font-family: "Courier New", Courier, monospace; font-size: 0.9rem; }
        .hidden { display: none; }
        .circuit-block { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 20px; background-color: #fafafa; }
        .circuit-header { display: flex; justify-content: space-between; align-items: center; }
        .circuit-header h2 { margin: 0; border: none; padding: 0; }
        .remove-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; }
        .document-group { display: flex; gap: 10px; }
        .document-group select { flex: 0 0 100px; }
        #loginContainer { max-width: 400px; margin: auto; }
        #appContainer { display: none; }
        #project-controls { background-color: #ecf0f1; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        #project-controls h2 { margin-top: 0; padding-top: 0; border-top: none; }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .controls-grid .form-group { grid-column: span 2; }
        .controls-grid .button-wrapper { grid-column: span 2; display: flex; gap: 10px; align-items: flex-end; justify-content: space-between; }
        .controls-grid .button-wrapper button { font-size: 0.9rem; padding: 12px; width: 100%;}
        .top-right-buttons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 2; }
        .top-right-buttons button { padding: 8px 15px; font-size: 0.9rem; }
        #adminPanelBtn, #manageProjectsBtn { display: none; }
        #logoutBtn { background-color: var(--primary-color); }
        #adminPanelBtn { background-color: var(--warning-color); }
        #manageProjectsBtn { background-color: #8e44ad; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--white); padding: 30px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2, .modal-content h3 { margin-top: 0; padding-top: 0; border: none; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .modal-footer button { font-size: 1rem; padding: 10px 20px; }
        #adminUserList { list-style-type: none; padding: 0; }
        #adminUserList li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .admin-user-actions button { font-size: 0.8rem; padding: 5px 10px; margin-left: 5px; }
        #adminProjectsTable { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        #adminProjectsTable th, #adminProjectsTable td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        #adminProjectsTable select { padding: 4px; font-size: 0.9rem; max-width: 150px; }
        #adminProjectsTable button { font-size: 0.8rem; padding: 5px 10px; margin-left: 5px; background-color: var(--secondary-color);}
        .approve-user-btn { background-color: var(--success-color); }
        .remove-user-btn { background-color: var(--danger-color); }
    </style>
</head>
<body>

<div id="registerModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <form id="registerForm">
            <h3>Cadastrar Novo Usuário</h3>
            <p>Após o cadastro, um administrador precisará aprovar seu acesso.</p>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group"><label for="regNome">Nome Completo</label><input type="text" id="regNome" required></div>
                <div class="form-group"><label for="regCpf">CPF</label><input type="text" id="regCpf" required maxlength="14"></div>
                <div class="form-group"><label for="regTelefone">Celular</label><input type="text" id="regTelefone" required maxlength="15"></div>
                <div class="form-group"><label for="regEmail">E-mail (para login)</label><input type="email" id="regEmail" required></div>
                <div class="form-group"><label for="regCrea">CREA</label><input type="text" id="regCrea" required></div>
                <div class="form-group"><label for="regPassword">Senha</label><input type="password" id="regPassword" required></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="close-modal-btn" style="background-color: var(--text-color);">Fechar</button>
                <button type="submit" style="background-color: var(--success-color);">Cadastrar</button>
            </div>
        </form>
    </div>
</div>

<div id="adminPanelModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <h3>Painel de Administrador - Gerenciar Usuários</h3>
        <ul id="adminUserList"></ul>
        <div class="modal-footer">
            <button type="button" class="close-modal-btn" style="background-color: var(--text-color);">Fechar</button>
        </div>
    </div>
</div>
<div id="editUserModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <form id="editUserForm">
            <h3>Editar Usuário</h3>
            <input type="hidden" id="editUserId">
            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group"><label for="editNome">Nome Completo</label><input type="text" id="editNome" required></div>
                <div class="form-group"><label for="editCpf">CPF</label><input type="text" id="editCpf" required maxlength="14"></div>
                <div class="form-group"><label for="editTelefone">Celular</label><input type="text" id="editTelefone" required maxlength="15"></div>
                <div class="form-group"><label for="editEmail">E-mail</label><input type="email" id="editEmail" required></div>
                <div class="form-group"><label for="editCrea">CREA</label><input type="text" id="editCrea" required></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="close-modal-btn" style="background-color: var(--text-color);">Cancelar</button>
                <button type="submit" style="background-color: var(--success-color);">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>
<div id="manageProjectsModalOverlay" class="modal-overlay">
     <div class="modal-content">
        <h3>Painel de Administrador - Gerenciar Obras</h3>
        <table id="adminProjectsTable">
            <thead>
                <tr>
                    <th>Obra</th>
                    <th>Proprietário Atual</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="adminProjectsTableBody"></tbody>
        </table>
        <div class="modal-footer">
            <button type="button" class="close-modal-btn" style="background-color: var(--text-color);">Fechar</button>
        </div>
    </div>
</div>

<div id="loginContainer" class="container">
    <h2>Login</h2>
    <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group"><label for="emailLogin">Email</label><input type="email" id="emailLogin" placeholder="seu@email.com"></div>
        <div class="form-group"><label for="password">Senha</label><input type="password" id="password" placeholder="Sua senha"></div>
    </div>
    <div class="button-container" style="margin-top: 20px;">
        <button id="loginBtn" style="background-color: var(--success-color); font-size: 1.2rem;">Entrar</button>
        <button id="registerBtn" style="background-color: var(--secondary-color); font-size: 1.2rem;">Cadastrar</button>
    </div>
</div>

<div id="appContainer" class="container">
    <div class="top-right-buttons">
        <button id="manageProjectsBtn">Gerenciar Obras</button>
        <button id="adminPanelBtn">Gerenciar Usuários</button>
        <button id="logoutBtn">Sair</button>
    </div>
    <h1>Calculadora de Projetos Elétricos</h1>
    <div id="project-controls">
        <h2>Gerenciar Obras</h2>
        <div class="controls-grid">
            <div class="form-group"><label for="searchInput">Pesquisar Obra/Cliente</label><input type="text" id="searchInput" placeholder="Digite nome, CPF/CNPJ ou obra..."></div>
            <div class="form-group"><label for="savedProjectsSelect">Obras Salvas</label><select id="savedProjectsSelect"></select></div>
            <div class="button-wrapper">
                 <button id="loadBtn" style="background-color: var(--success-color);">Carregar Obra</button>
                 <button id="saveBtn" style="background-color: var(--secondary-color);">Salvar/Atualizar</button>
                 <button id="deleteBtn" style="background-color: var(--danger-color);">Excluir Obra</button>
                 <button id="newBtn" style="background-color: var(--warning-color);">Nova Obra</button>
            </div>
        </div>
    </div>
    <form id="main-form">
        <input type="hidden" id="currentProjectId">
        <h2>Informações da Obra/Cliente</h2>
        <div class="form-grid">
            <div class="form-group"><label for="codigoCliente">Código do Cliente</label><input type="text" id="codigoCliente" readonly placeholder="Será gerado ao salvar"></div>
            <div class="form-group"><label for="cliente">Cliente</label><input type="text" id="cliente" placeholder="Nome do cliente"></div>
            <div class="form-group"><label for="tipoDocumento">Documento</label><div class="document-group"><select id="tipoDocumento"><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select><input type="text" id="documento" placeholder="000.000.000-00" maxlength="18"></div></div>
            <div class="form-group"><label for="telefone">Telefone</label><input type="text" id="telefone" placeholder="(00) 0000-0000" maxlength="14"></div>
            <div class="form-group"><label for="celular">Celular</label><input type="text" id="celular" placeholder="(00) 00000-0000" maxlength="15"></div>
            <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" placeholder="contato@email.com"></div>
            <div class="form-group"><label for="obra">Obra (Nome do Projeto)</label><input type="text" id="obra" placeholder="Residência Unifamiliar - Usado para salvar"></div>
            <div class="form-group"><label for="endereco">Endereço</label><input type="text" id="endereco" placeholder="Rua, N°, Bairro, Cidade - UF"></div>
            <div class="form-group"><label for="areaObra">Área da Obra (m²)</label><input type="number" id="areaObra" placeholder="150"></div>
        </div>
    </form>
    <div id="circuits-container"></div>
    <button id="addCircuitBtn" style="background-color: var(--secondary-color); font-size: 1rem; padding: 12px; margin-bottom: 20px;">Adicionar Circuito</button>
    <form id="tech-form">
        <h2>Informações do Responsável Técnico</h2>
        <div class="form-grid">
            <div class="form-group"><label for="respTecnico">Responsável Técnico</label><input type="text" id="respTecnico" placeholder="Nome do profissional"></div>
            <div class="form-group"><label for="titulo">Título</label><input type="text" id="titulo" placeholder="Engenheiro Eletricista"></div>
            <div class="form-group"><label for="crea">CREA</label><input type="text" id="crea" placeholder="XXXXXXXX-X"></div>
        </div>
    </form>
    <div class="button-container">
        <button id="calculateBtn" style="background-color: var(--success-color);">Calcular e Gerar Relatório</button>
        <button id="pdfBtn" style="background-color: #c0392b;">Gerar PDF do Relatório</button>
    </div>
    <pre id="report">O relatório aparecerá aqui.</pre>
</div>

<script>
    // --- CONFIGURAÇÃO E CLIENTE SUPABASE ---
    const SUPABASE_URL = 'https://ahuvldyeownupkgjqusl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFodXZsZHllb3dudXBrZ2pxdXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMDc3MDUsImV4cCI6MjA3MDc4MzcwNX0.pkDtP_ziDZzh2QNSN0FCDMA4PUbrgdvTPtP6-6O5W9k';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- VARIÁVEIS GLOBAIS ---
    let circuitCount = 0;
    let currentUserProfile = null; // Armazena o perfil do usuário logado
    const circuitsContainer = document.getElementById('circuits-container');
    const ligacoes = { Monofasico: [{value:'FN', text:'Fase-Neutro (FN)'}, {value:'FF', text:'Fase-Fase (FF)'}], Bifasico: [{value:'FF', text:'Fase-Fase (FF)'}, {value:'FFN', text:'Fase-Fase-Neutro (FFN)'}], Trifasico: [{value:'FFF', text:'Fase-Fase-Fase (FFF)'}, {value:'FFFN', text:'Fase-Fase-Fase-Neutro (FFFN)'}] };

    // --- DEMAIS CONSTANTES E TABELAS (CÓDIGO ORIGINAL MANTIDO) ---
    // (As tabelas de cabos, disjuntores, etc., foram omitidas aqui para economizar espaço, mas elas permanecem no código)
    const tabelasDeCabos = { Cobre: { PVC: [ { secao: 1.5, capacidade: { A1: 13.5, A2: 13, B1: 15.5, B2: 15, C: 17.5, D: 18 } }, { secao: 2.5, capacidade: { A1: 18, A2: 17.5, B1: 21, B2: 20, C: 24, D: 24 } }, { secao: 4, capacidade: { A1: 24, A2: 23, B1: 28, B2: 27, C: 32, D: 31 } }, { secao: 6, capacidade: { A1: 31, A2: 29, B1: 36, B2: 24, C: 41, D: 39 } }, { secao: 10, capacidade: { A1: 45, A2: 39, B1: 50, B2: 46, C: 57, D: 52 } }, { secao: 16, capacidade: { A1: 56, A2: 52, B1: 68, B2: 62, C: 76, D: 67 } }, { secao: 25, capacidade: { A1: 73, A2: 68, B1: 89, B2: 80, C: 96, D: 86 } }, { secao: 35, capacidade: { A1: 89, A2: 83, B1: 110, B2: 99, C: 119, D: 103 } }, { secao: 50, capacidade: { A1: 108, A2: 99, B1: 134, B2: 118, C: 144, D: 122 } }, { secao: 70, capacidade: { A1: 136, A2: 125, B1: 171, B2: 149, C: 184, D: 151 } }, { secao: 95, capacidade: { A1: 164, A2: 150, B1: 207, B2: 179, C: 223, D: 179 } }, { secao: 120, capacidade: { A1: 188, A2: 172, B1: 239, B2: 206, C: 259, D: 203 } }, { secao: 150, capacidade: { A1: 216, A2: 196, B1: 275, B2: 236, C: 299, D: 230 } }, { secao: 185, capacidade: { A1: 245, A2: 223, B1: 314, B2: 268, C: 341, D: 258 } }, { secao: 240, capacidade: { A1: 286, A2: 261, B1: 370, B2: 313, C: 403, D: 297 } }, { secao: 300, capacidade: { A1: 328, A2: 298, B1: 426, B2: 358, C: 464, D: 336 } }, { secao: 400, capacidade: { A1: 390, A2: 355, B1: 510, B2: 425, C: 557, D: 394 } }, { secao: 500, capacidade: { A1: 447, A2: 406, B1: 587, B2: 486, C: 642, D: 445 } }, { secao: 630, capacidade: { A1: 514, A2: 467, B1: 678, B2: 559, C: 743, D: 506 } }, { secao: 800, capacidade: { A1: 593, A2: 540, B1: 788, B2: 645, C: 865, D: 652 } } ], EPR: [ { secao: 1.5, capacidade: { A1: 17, A2: 16.5, B1: 22, B2: 19.5, C: 22, D: 24 } }, { secao: 2.5, capacidade: { A1: 23, A2: 22, B1: 28, B2: 26, C: 30, D: 29 } }, { secao: 4, capacidade: { A1: 31, A2: 30, B1: 37, B2: 35, C: 40, D: 37 } }, { secao: 6, capacidade: { A1: 40, A2: 38, B1: 48, B2: 44, C: 52, D: 46 } }, { secao: 10, capacidade: { A1: 54, A2: 51, B1: 66, B2: 60, C: 71, D: 61 } }, { secao: 16, capacidade: { A1: 73, A2: 68, B1: 88, B2: 80, C: 96, D: 79 } }, { secao: 25, capacidade: { A1: 95, A2: 89, B1: 117, B2: 105, C: 119, D: 101 } }, { secao: 35, capacidade: { A1: 117, A2: 109, B1: 144, B2: 128, C: 147, D: 122 } }, { secao: 50, capacidade: { A1: 141, A2: 130, B1: 175, B2: 154, C: 179, D: 144 } }, { secao: 70, capacidade: { A1: 179, A2: 164, B1: 222, B2: 194, C: 229, D: 178 } }, { secao: 95, capacidade: { A1: 216, A2: 197, B1: 269, B2: 233, C: 278, D: 211 } }, { secao: 120, capacidade: { A1: 249, A2: 227, B1: 312, B2: 268, C: 322, D: 240 } }, { secao: 150, capacidade: { A1: 285, A2: 259, B1: 358, B2: 307, C: 371, D: 271 } }, { secao: 185, capacidade: { A1: 324, A2: 295, B1: 408, B2: 348, C: 424, D: 304 } }, { secao: 240, capacidade: { A1: 380, A2: 346, B1: 481, B2: 407, C: 500, D: 351 } }, { secao: 300, capacidade: { A1: 435, A2: 396, B1: 553, B2: 465, C: 576, D: 396 } }, { secao: 400, capacidade: { A1: 519, A2: 472, B1: 661, B2: 552, C: 692, D: 464 } }, { secao: 500, capacidade: { A1: 595, A2: 541, B1: 760, B2: 631, C: 797, D: 525 } }, { secao: 630, capacidade: { A1: 685, A2: 623, B1: 879, B2: 725, C: 923, D: 596 } }, { secao: 800, capacidade: { A1: 792, A2: 721, B1: 1020, B2: 837, C: 1074, D: 677 } } ] }, Aluminio: { PVC: [ { secao: 10, capacidade: { A1: 31, A2: 29, B1: 39, B2: 38, C: 41, D: 46 } }, { secao: 16, capacidade: { A1: 41, A2: 39, B1: 52, B2: 51, C: 55, D: 60 } }, { secao: 25, capacidade: { A1: 55, A2: 51, B1: 68, B2: 66, C: 73, D: 77 } }, { secao: 35, capacidade: { A1: 68, A2: 63, B1: 85, B2: 83, C: 91, D: 93 } }, { secao: 50, capacidade: { A1: 81, A2: 76, B1: 104, B2: 100, C: 110, D: 111 } }, { secao: 70, capacidade: { A1: 105, A2: 98, B1: 134, B2: 128, C: 141, D: 138 } }, { secao: 95, capacidade: { A1: 128, A2: 119, B1: 162, B2: 155, C: 171, D: 163 } }, { secao: 120, capacidade: { A1: 147, A2: 137, B1: 186, B2: 178, C: 197, D: 183 } }, { secao: 150, capacidade: { A1: 168, A2: 156, B1: 213, B2: 203, C: 226, D: 206 } }, { secao: 185, capacidade: { A1: 192, A2: 179, B1: 243, B2: 231, C: 258, D: 232 } }, { secao: 240, capacidade: { A1: 228, A2: 213, B1: 289, B2: 275, C: 306, D: 270 } }, { secao: 300, capacidade: { A1: 262, A2: 244, B1: 332, B2: 316, C: 353, D: 305 } }, { secao: 400, capacidade: { A1: 312, A2: 291, B1: 397, B2: 378, C: 423, D: 358 } }, { secao: 500, capacidade: { A1: 361, A2: 336, B1: 460, B2: 439, C: 491, D: 405 } }, { secao: 630, capacidade: { A1: 423, A2: 395, B1: 542, B2: 518, C: 579, D: 465 } }, { secao: 800, capacidade: { A1: 500, A2: 468, B1: 643, B2: 616, C: 687, D: 536 } } ], EPR: [ { secao: 10, capacidade: { A1: 40, A2: 37, B1: 50, B2: 49, C: 53, D: 59 } }, { secao: 16, capacidade: { A1: 53, A2: 50, B1: 67, B2: 65, C: 71, D: 77 } }, { secao: 25, capacidade: { A1: 70, A2: 66, B1: 88, B2: 85, C: 94, D: 99 } }, { secao: 35, capacidade: { A1: 87, A2: 81, B1: 109, B2: 106, C: 117, D: 120 } }, { secao: 50, capacidade: { A1: 105, A2: 98, B1: 134, B2: 129, C: 142, D: 142 } }, { secao: 70, capacidade: { A1: 135, A2: 126, B1: 172, B2: 165, C: 182, D: 177 } }, { secao: 95, capacidade: { A1: 165, A2: 153, B1: 208, B2: 200, C: 220, D: 210 } }, { secao: 120, capacity: { A1: 189, A2: 176, B1: 239, B2: 229, C: 253, D: 236 } }, { secao: 150, capacidade: { A1: 216, A2: 201, B1: 274, B2: 261, C: 290, D: 265 } }, { secao: 185, capacidade: { A1: 247, A2: 230, B1: 312, B2: 297, C: 331, D: 298 } }, { secao: 240, capacidade: { A1: 293, A2: 274, B1: 372, B2: 354, C: 394, D: 347 } }, { secao: 300, capacidade: { A1: 336, A2: 314, B1: 426, B2: 406, C: 453, D: 393 } }, { secao: 400, capacidade: { A1: 401, A2: 375, B1: 511, B2: 486, C: 544, D: 461 } }, { secao: 500, capacidade: { A1: 464, A2: 434, B1: 591, B2: 564, C: 631, D: 521 } }, { secao: 630, capacidade: { A1: 544, A2: 509, B1: 697, B2: 666, C: 745, D: 600 } }, { secao: 800, capacidade: { A1: 643, A2: 603, B1: 827, B2: 792, C: 885, D: 691 } } ] } };
    const tabelaK1_temp = { 10: 1.08, 15: 1.04, 20: 1.00, 25: 0.96, 30: 0.91, 35: 0.87, 40: 0.82, 45: 0.76, 50: 0.71 };
    const tabelaK2_solo = { 0.7: 1.29, 0.8: 1.23, 1.0: 1.18, 1.5: 1.05, 2.0: 0.96, 2.5: 0.89, 3.0: 0.83 };
    const tabelaK3_agrupamento = { 1: [1.00, 1.00, 1.00, 1.00, 1.00, 1.00], 2: [0.80, 0.85, 0.88, 0.94, 0.82, 0.79], 3: [0.70, 0.76, 0.80, 0.88, 0.73, 0.69], 4: [0.65, 0.70, 0.75, 0.84, 0.67, 0.63], 5: [0.60, 0.66, 0.70, 0.80, 0.63, 0.58], 6: [0.57, 0.62, 0.67, 0.77, 0.59, 0.54] };
    const metodoParaColunaK3 = { "A1": 2, "A2": 2, "B1": 2, "B2": 2, "C": 0, "D": 0 };
    const tabelaDutos = { 2: { 1.5: "20mm (1/2\")", 2.5: "20mm (1/2\")", 4.0: "25mm (3/4\")", 6.0: "25mm (3/4\")", 10.0: "32mm (1\")", 16: "32mm (1\")", 25: "40mm (1 1/4\")", 35: "40mm (1 1/4\")", 50: "50mm (1 1/2\")", 70: "60mm (2\")", 95: "60mm (2\")" }, 3: { 1.5: "20mm (1/2\")", 2.5: "25mm (3/4\")", 4.0: "25mm (3/4\")", 6.0: "32mm (1\")", 10.0: "32mm (1\")", 16: "40mm (1 1/4\")", 25: "50mm (1 1/2\")", 35: "50mm (1 1/2\")", 50: "60mm (2\")", 70: "75mm (2 1/2\")", 95: "75mm (2 1/2\")" }, 4: { 1.5: "25mm (3/4\")", 2.5: "25mm (3/4\")", 4.0: "32mm (1\")", 6: "32mm (1\")", 10: "40mm (1 1/4\")", 16: "50mm (1 1/2\")", 25: "50mm (1 1/2\")", 35: "60mm (2\")", 50: "60mm (2\")", 70: "75mm (2 1/2\")", 95: "85mm (3\")" } };
    const tabelaDisjuntores = { "Minidisjuntor (DIN)": [ { corrente: 10, nome: "10A", icc: 2 }, { corrente: 16, nome: "16A", icc: 2 }, { corrente: 20, nome: "20A", icc: 2 }, { corrente: 25, nome: "25A", icc: 3 }, { corrente: 32, nome: "32A", icc: 3 }, { corrente: 40, nome: "40A", icc: 4 }, { corrente: 50, nome: "50A", icc: 5 }, { corrente: 63, nome: "63A", icc: 6 }, { corrente: 80, nome: "80A", icc: 7 }, { corrente: 100, nome: "100A", icc: 8 }, { corrente: 125, nome: "125A", icc: 10 } ], "Caixa Moldada (MCCB)": [ { corrente: 70, nome: "70A", icc: 5 }, { corrente: 80, nome: "80A", icc: 6 }, { corrente: 100, nome: "100A", icc: 8 }, { corrente: 125, nome: "125A", icc: 10 }, { corrente: 160, nome: "160A", icc: 12 }, { corrente: 200, nome: "200A", icc: 15 }, { corrente: 250, nome: "250A", icc: 20 }, { corrente: 320, nome: "320A", icc: 25 }, { corrente: 400, nome: "400A", icc: 30 }, { corrente: 500, nome: "500A", icc: 40 }, { corrente: 630, nome: "630A", icc: 50 }, { corrente: 800, nome: "800A", icc: 60 }, { corrente: 1000, nome: "1000A", icc: 80 } ] };

    // --- LÓGICA DA APLICAÇÃO (CÁLCULOS E UI) ---
    // (A maioria das funções daqui para baixo foi modificada para usar 'async' e chamadas ao Supabase)

    function getCircuitHTML(id){return `<div class="circuit-block" id="circuit-${id}" data-id="${id}"><div class="circuit-header"><h2 id="circuit-title-${id}">Circuito ${id}</h2>${id>1?`<button class="remove-btn" data-circuit-id="${id}">Remover</button>`:''}</div><div class="form-grid"><div class="form-group"><label for="nomeCircuito-${id}">Nome do Circuito</label><input type="text" id="nomeCircuito-${id}" value="Circuito ${id}"></div><div class="form-group"><label for="tipoCircuito-${id}">Tipo de Circuito</label><select id="tipoCircuito-${id}"><option value="alimentacao_geral">Alimentacao Geral</option><option value="iluminacao">Iluminacao</option><option value="tug" selected>Tomadas de Uso Geral (TUG)</option><option value="tue">Tomadas de Uso Especifico (TUE)</option><option value="aquecimento">Aquecimento</option><option value="motores">Circuito de Motores</option><option value="ar_condicionado">Ar Condicionado</option></select></div><div class="form-group" id="potenciaW_group-${id}"><label for="potenciaW-${id}">Potencia (W)</label><input type="number" id="potenciaW-${id}" value="2500"></div><div class="form-group hidden" id="potenciaCV_group-${id}"><label for="potenciaCV-${id}">Potencia do Motor (CV)</label><select id="potenciaCV-${id}"><option value="0.25">1/4</option><option value="0.33">1/3</option><option value="0.5">1/2</option><option value="0.75">3/4</option><option value="1">1</option><option value="1.5">1 1/2</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="7.5">7 1/2</option><option value="10">10</option><option value="12.5">12 1/2</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option></select></div><div class="form-group"><label for="fatorDemanda-${id}">Fator de Demanda</label><select id="fatorDemanda-${id}"><option value="0.50">0.50</option><option value="0.55">0.55</option><option value="0.60">0.60</option><option value="0.65">0.65</option><option value="0.70">0.70</option><option value="0.75">0.75</option><option value="0.80">0.80</option><option value="0.85">0.85</option><option value="0.90">0.90</option><option value="0.92">0.92</option><option value="0.95">0.95</option><option value="1" selected>1.00</option><option value="1.10">1.10</option><option value="1.15">1.15</option><option value="1.20">1.20</option><option value="1.25">1.25</option><option value="1.30">1.30</option></select></div><div class="form-group"><label for="fases-${id}">Sistema de Fases</label><select id="fases-${id}"><option value="Monofasico" selected>Monofasico</option><option value="Bifasico">Bifasico</option><option value="Trifasico">Trifasico</option></select></div><div class="form-group"><label for="tipoLigacao-${id}">Tipo de Ligacao</label><select id="tipoLigacao-${id}"></select></div><div class="form-group"><label for="tensaoV-${id}">Tensao (V)</label><select id="tensaoV-${id}"><option value="12">12 V</option><option value="24">24 V</option><option value="36">36 V</option><option value="127">127 V</option><option value="220" selected>220 V</option><option value="380">380 V</option><option value="440">440 V</option><option value="760">760 V</option></select></div><div class="form-group"><label for="fatorPotencia-${id}">Fator de Potencia (eficiencia)</label><input type="number" id="fatorPotencia-${id}" step="0.01" value="0.92"></div><div class="form-group"><label for="comprimentoM-${id}">Comprimento (m)</label><input type="number" id="comprimentoM-${id}" value="20"></div><div class="form-group"><label for="tipoIsolacao-${id}">Tipo de Isolacao</label><select id="tipoIsolacao-${id}"><option value="PVC" selected>PVC 70 C</option><option value="EPR">EPR/XLPE 90 C</option></select></div><div class="form-group"><label for="materialCabo-${id}">Material do Condutor</label><select id="materialCabo-${id}"><option value="Cobre" selected>Cobre</option><option value="Aluminio">Aluminio</option></select></div><div class="form-group"><label for="metodoInstalacao-${id}">Metodo de Instalacao</label><select id="metodoInstalacao-${id}"><option value="A1">A1</option><option value="A2">A2</option><option value="B1" selected>B1</option><option value="B2">B2</option><option value="C">C</option><option value="D">D</option></select></div><div class="form-group"><label for="temperaturaAmbienteC-${id}">Temperatura Ambiente (C)</label><select id="temperaturaAmbienteC-${id}"><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30" selected>30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option></select></div><div class="form-group"><label for="resistividadeSolo-${id}">Resistividade T. do Solo (C.m/W)</label><select id="resistividadeSolo-${id}"><option value="0" selected>Nao Aplicavel</option><option value="0.7">0.7</option><option value="0.8">0.8</option><option value="1.0">1.0</option><option value="1.5">1.5</option><option value="2.0">2.0</option><option value="2.5">2.5</option><option value="3.0">3.0</option></select></div><div class="form-group"><label for="numCircuitosAgrupados-${id}">N de Circuitos Agrupados</label><input type="number" id="numCircuitosAgrupados-${id}" value="1"></div><div class="form-group"><label for="limiteQuedaTensao-${id}">Limite Queda de Tensao (%)</label><input type="number" id="limiteQuedaTensao-${id}" step="0.1" value="4.0"></div><div class="form-group"><label for="tipoDisjuntor-${id}">Tipo de Disjuntor</label><select id="tipoDisjuntor-${id}"><option value="Minidisjuntor (DIN)">Minidisjuntor (DIN)</option><option value="Caixa Moldada (MCCB)">Caixa Moldada (MCCB)</option></select></div><div class="form-group"><label for="classeDPS-${id}">Protecao DPS</label><select id="classeDPS-${id}"><option value="Nenhum">Nenhuma</option><option value="Classe I">Classe I</option><option value="Classe II">Classe II</option><option value="Classe III">Classe III</option></select><div class="checkbox-group"><input type="checkbox" id="requerDR-${id}"><label for="requerDR-${id}">Requer Protecao DR</label></div></div></div></div>`;}
    function initializeCircuitListeners(id){const tipoCircuito=document.getElementById(`tipoCircuito-${id}`);const fases=document.getElementById(`fases-${id}`);const tipoLigacao=document.getElementById(`tipoLigacao-${id}`);const potenciaWGroup=document.getElementById(`potenciaW_group-${id}`);const potenciaCVGroup=document.getElementById(`potenciaCV_group-${id}`);const atualizarLigacoes=()=>{const faseSelecionada=fases.value;const ligacoesDisponiveis=ligacoes[faseSelecionada]||[];tipoLigacao.innerHTML='';ligacoesDisponiveis.forEach(opt=>{const option=document.createElement('option');option.value=opt.value;option.textContent=opt.text;tipoLigacao.appendChild(option)})};tipoCircuito.addEventListener('change',()=>{potenciaWGroup.classList.toggle('hidden',tipoCircuito.value==='motores');potenciaCVGroup.classList.toggle('hidden',tipoCircuito.value!=='motores')});fases.addEventListener('change',atualizarLigacoes);atualizarLigacoes()}
    function addCircuit(){circuitCount++;const newCircuitDiv=document.createElement('div');newCircuitDiv.innerHTML=getCircuitHTML(circuitCount);circuitsContainer.appendChild(newCircuitDiv.firstElementChild);initializeCircuitListeners(circuitCount)}
    function removeCircuit(id){document.getElementById(`circuit-${id}`)?.remove();renumberCircuits()}
    function renumberCircuits(){const circuitBlocks=document.querySelectorAll('.circuit-block');circuitCount=circuitBlocks.length;circuitBlocks.forEach((block,index)=>{const newId=index+1;const oldId=parseInt(block.dataset.id);if(oldId===newId)return;block.dataset.id=newId;block.id=`circuit-${newId}`;block.querySelectorAll('[id],[for],[data-circuit-id]').forEach(el=>{const props=['id','htmlFor','data-circuit-id'];props.forEach(prop=>{if(el[prop]&&String(el[prop]).includes(`-${oldId}`)){el[prop]=el[prop].replace(`-${oldId}`,`-${newId}`)}})});block.querySelector('h2').textContent=`Circuito ${newId}`})}
    function mascaraCPF(event){event.target.value=event.target.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}
    function mascaraCelular(event){event.target.value=event.target.value.replace(/\D/g,'').replace(/^(\d{2})(\d)/g,'($1) $2').replace(/(\d{5})(\d{4})$/,'$1-$2')}
    function mascaraTelefone(event){event.target.value=event.target.value.replace(/\D/g,'').replace(/^(\d{2})(\d)/g,'($1) $2').replace(/(\d{4})(\d)/,'$1-$2')}
    function aplicarMascara(event){const tipoDoc=document.getElementById('tipoDocumento').value;let value=event.target.value.replace(/\D/g,"");if(tipoDoc==='CPF'){value=value.slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}else{value=value.slice(0,14).replace(/^(\d{2})(\d)/,'$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/,'$1.$2.$3').replace(/\.(\d{3})(\d)/,'.$1/$2').replace(/(\d{4})(\d)/,'$1-$2')}
    event.target.value=value}
    function atualizarMascaraDocumento(){const tipoDoc=document.getElementById('tipoDocumento').value;const inputDoc=document.getElementById('documento');inputDoc.value='';if(tipoDoc==='CPF'){inputDoc.placeholder='000.000.000-00';inputDoc.maxLength=14}else{inputDoc.placeholder='00.000.000/0000-00';inputDoc.maxLength=18}}

    // --- CÁLCULO E GERAÇÃO DE RELATÓRIOS (LÓGICA ORIGINAL) ---
    function calcularTodosCircuitos(){const allResults=[];const circuitBlocks=document.querySelectorAll('.circuit-block');if(circuitBlocks.length===0){alert("Adicione pelo menos um circuito para calcular.");return null}
    circuitBlocks.forEach(block=>{const id=block.dataset.id;const dados={id:id,cliente:document.getElementById('cliente').value,tipoDocumento:document.getElementById('tipoDocumento').value,documento:document.getElementById('documento').value,telefone:document.getElementById('telefone').value,celular:document.getElementById('celular').value,email:document.getElementById('email').value,obra:document.getElementById('obra').value,endereco:document.getElementById('endereco').value,areaObra:document.getElementById('areaObra').value,nomeCircuito:document.getElementById(`nomeCircuito-${id}`).value,tipoCircuito:document.getElementById(`tipoCircuito-${id}`).value,potenciaW:parseFloat(document.getElementById(`potenciaW-${id}`).value),potenciaCV:parseFloat(document.getElementById(`potenciaCV-${id}`).value),fatorDemanda:parseFloat(document.getElementById(`fatorDemanda-${id}`).value),fases:document.getElementById(`fases-${id}`).value,tipoLigacao:document.getElementById(`tipoLigacao-${id}`).value,tensaoV:parseFloat(document.getElementById(`tensaoV-${id}`).value),fatorPotencia:parseFloat(document.getElementById(`fatorPotencia-${id}`).value),comprimentoM:parseFloat(document.getElementById(`comprimentoM-${id}`).value),tipoIsolacao:document.getElementById(`tipoIsolacao-${id}`).value,materialCabo:document.getElementById(`materialCabo-${id}`).value,metodoInstalacao:document.getElementById(`metodoInstalacao-${id}`).value,temperaturaAmbienteC:parseInt(document.getElementById(`temperaturaAmbienteC-${id}`).value),resistividadeSolo:parseFloat(document.getElementById(`resistividadeSolo-${id}`).value),numCircuitosAgrupados:parseInt(document.getElementById(`numCircuitosAgrupados-${id}`).value),limiteQuedaTensao:parseFloat(document.getElementById(`limiteQuedaTensao-${id}`).value),tipoDisjuntor:document.getElementById(`tipoDisjuntor-${id}`).value,requerDR:document.getElementById(`requerDR-${id}`).checked,classeDPS:document.getElementById(`classeDPS-${id}`).value,};if(dados.tipoCircuito==='motores')dados.potenciaW=dados.potenciaCV*735.5;const potenciaInstalada=dados.potenciaW;const potenciaDemandada=potenciaInstalada*dados.fatorDemanda;const correnteInstalada=(dados.fases==='Trifasico')?(potenciaInstalada/(dados.tensaoV*1.732*dados.fatorPotencia)):(potenciaInstalada/(dados.tensaoV*dados.fatorPotencia));const correnteDemandada=(dados.fases==='Trifasico')?(potenciaDemandada/(dados.tensaoV*1.732*dados.fatorPotencia)):(potenciaDemandada/(dados.tensaoV*dados.fatorPotencia));const fatorK1=tabelaK1_temp[dados.temperaturaAmbienteC]||1.0;const fatorK2=(dados.resistividadeSolo>0&&tabelaK2_solo[dados.resistividadeSolo])?tabelaK2_solo[dados.resistividadeSolo]:1.0;let fatorK3=1.0;if(tabelaK3_agrupamento[dados.numCircuitosAgrupados]){const colunaIdx=metodoParaColunaK3[dados.metodoInstalacao];if(colunaIdx!==undefined){fatorK3=tabelaK3_agrupamento[dados.numCircuitosAgrupados][colunaIdx]||1.0}}
    const correnteCorrigidaA=correnteDemandada/(fatorK1*fatorK2*fatorK3);let bitolaRecomendadaMm2="Nao encontrada",quedaTensaoCalculada=0,resistenciaCabo=0,correnteMaximaCabo=0,disjuntorRecomendado={nome:"Coord. Inadequada",icc:0};const listaDisjuntores=tabelaDisjuntores[dados.tipoDisjuntor]||[];let disjuntorCandidato=null;for(const disjuntor of listaDisjuntores){if(disjuntor.corrente>=correnteDemandada){disjuntorCandidato=disjuntor;break}}
    if(disjuntorCandidato){let bitolaMinima=0;if(dados.tipoCircuito==='iluminacao')bitolaMinima=1.5;if(dados.tipoCircuito==='tug'||dados.tipoCircuito==='tue'||dados.tipoCircuito==='ar_condicionado')bitolaMinima=2.5;const tabelaCaboSelecionada=tabelasDeCabos[dados.materialCabo][dados.tipoIsolacao];const startIndex=tabelaCaboSelecionada.findIndex(c=>c.secao>=bitolaMinima);if(startIndex!==-1){for(let i=startIndex;i<tabelaCaboSelecionada.length;i++){const cabo=tabelaCaboSelecionada[i];const capacidadeConducao=cabo.capacidade[dados.metodoInstalacao]||0;const Iz=capacidadeConducao*fatorK1*fatorK2*fatorK3;if(Iz>=disjuntorCandidato.corrente){const resistividade=(dados.materialCabo==='Cobre')?0.0172:0.0282;let quedaVolts=(dados.fases==='Trifasico')?((1.732*resistividade*dados.comprimentoM*correnteDemandada)/cabo.secao):((2*resistividade*dados.comprimentoM*correnteDemandada)/cabo.secao);const quedaPercentual=(quedaVolts/dados.tensaoV)*100.0;if(quedaPercentual<=dados.limiteQuedaTensao){bitolaRecomendadaMm2=cabo.secao.toString();quedaTensaoCalculada=quedaPercentual;resistenciaCabo=(resistividade*dados.comprimentoM)/cabo.secao;correnteMaximaCabo=Iz;disjuntorRecomendado=disjuntorCandidato;break}}}}}
    const potenciaMaximaCabo=(dados.fases==='Trifasico')?(dados.tensaoV*correnteMaximaCabo*1.732*dados.fatorPotencia):(dados.tensaoV*correnteMaximaCabo*dados.fatorPotencia);let numCondutores=0;if(dados.fases==='Monofasico'){numCondutores=2}else if(dados.fases==='Bifasico'){if(dados.tipoLigacao==='FF')numCondutores=2;else if(dados.tipoLigacao==='FFN')numCondutores=3}else if(dados.fases==='Trifasico'){if(dados.tipoLigacao==='FFF')numCondutores=3;else if(dados.tipoLigacao==='FFFN')numCondutores=4}
    let dutoRecomendado="Nao encontrado";const bitolaNum=parseFloat(bitolaRecomendadaMm2);if(tabelaDutos[numCondutores]&&tabelaDutos[numCondutores][bitolaNum]){dutoRecomendado=tabelaDutos[numCondutores][bitolaNum]}
    allResults.push({dados,calculos:{potenciaInstalada,correnteInstalada,potenciaDemandada,correnteDemandada,fatorK1,fatorK2,fatorK3,correnteCorrigidaA,bitolaRecomendadaMm2,resistenciaCabo,quedaTensaoCalculada,correnteMaximaCabo,potenciaMaximaCabo,disjuntorRecomendado,numCondutores,dutoRecomendado}})});gerarRelatorioTexto(allResults);return allResults}
    function gerarRelatorioTexto(allResults){if(!allResults||allResults.length===0)return;const dataHora=(new Date).toLocaleString('pt-BR');const formatLine=(label,value)=>(label+':').padEnd(28,' ')+value;let reportText=`======================================================\n==           RELATORIO DE PROJETO ELETRICO           ==\n======================================================\n${formatLine('Gerado em',dataHora)}\n`;const dadosCliente=allResults[0].dados;reportText+=`\n-- DADOS DA OBRA E CLIENTE --\n`;reportText+=`${formatLine('Cliente',dadosCliente.cliente||'Nao informado')}\n`;reportText+=`${formatLine(`Documento (${dadosCliente.tipoDocumento})`,dadosCliente.documento||'Nao informado')}\n`;reportText+=`${formatLine('Contato',dadosCliente.celular||dadosCliente.telefone||'Nao informado')}\n`;reportText+=`${formatLine('E-mail',dadosCliente.email||'Nao informado')}\n`;reportText+=`${formatLine('Obra',dadosCliente.obra||'Nao informado')}\n`;reportText+=`${formatLine('Endereco',dadosCliente.endereco||'Nao informado')}\n`;reportText+=`${formatLine('Area da Obra',(dadosCliente.areaObra||'Nao informado')+' m2')}\n`;const respTecnico=document.getElementById('respTecnico').value;const titulo=document.getElementById('titulo').value;const crea=document.getElementById('crea').value;if(respTecnico||titulo||crea){reportText+=`\n-- RESPONSAVEL TECNICO --\n`;reportText+=`${formatLine('Nome',respTecnico||'Nao informado')}\n`;reportText+=`${formatLine('Titulo',titulo||'Nao informado')}\n`;reportText+=`${formatLine('CREA',crea||'Nao informado')}\n`}
    reportText+=`\n-- QUADRO DE CARGAS RESUMIDO --\n`;allResults.forEach(result=>{reportText+=`${formatLine(`Circuito ${result.dados.id}`,`${result.dados.nomeCircuito} - ${result.calculos.potenciaDemandada.toFixed(2)} W`)}\n`});allResults.forEach(result=>{const{dados,calculos}=result;reportText+=`\n\n======================================================\n==           MEMORIAL DE CALCULO - CIRCUITO ${dados.id}           ==\n======================================================\n`;reportText+=`\n-- IDENTIFICACAO DO CIRCUITO --\n`;reportText+=`${formatLine('Nome do Circuito',dados.nomeCircuito)}\n`;reportText+=`${formatLine('Tipo de Circuito',dados.tipoCircuito.replace(/_/g,' '))}\n`;reportText+=`\n-- CARGA E DEMANDA --\n`;reportText+=`${formatLine('Potencia Instalada',`${calculos.potenciaInstalada.toFixed(2)} W`)}\n`;reportText+=`${formatLine('Corrente Instalada',`${calculos.correnteInstalada.toFixed(2)} A`)}\n`;reportText+=`${formatLine('Fator de Demanda Aplicado',dados.fatorDemanda.toFixed(2))}\n`;reportText+=`${formatLine('Potencia Demandada',`${calculos.potenciaDemandada.toFixed(2)} W`)}\n`;reportText+=`${formatLine('Corrente Demandada (Ib)',`${calculos.correnteDemandada.toFixed(2)} A`)}\n`;reportText+=`\n-- ESPECIFICACOES DO CABO E CORRECOES --\n`;reportText+=`${formatLine('Material / Isolacao',`${dados.materialCabo} / ${dados.tipoIsolacao}`)}\n`;reportText+=`${formatLine('Metodo de Instalacao',dados.metodoInstalacao)}\n`;reportText+=`${formatLine('Fatores de Correcao',`K1=${calculos.fatorK1.toFixed(2)}, K2=${calculos.fatorK2.toFixed(2)}, K3=${calculos.fatorK3.toFixed(2)}`)}\n`;reportText+=`${formatLine('Corrente p/ Dimensionar',`${calculos.correnteCorrigidaA.toFixed(2)} A`)}\n`;reportText+=`\n-- RESULTADOS DE DIMENSIONAMENTO --\n`;reportText+=`${formatLine('Bitola Recomendada',`${calculos.bitolaRecomendadaMm2} mm2`)}\n`;reportText+=`${formatLine('Resistencia do Cabo',`${calculos.resistenciaCabo.toFixed(4)} Ohm`)}\n`;reportText+=`${formatLine('Queda de Tensao (DV)',`${calculos.quedaTensaoCalculada.toFixed(2)} %`)}\n`;reportText+=`${formatLine('Limite de Queda de Tensao',`${dados.limiteQuedaTensao.toFixed(2)} %`)}\n`;reportText+=`${formatLine('Corrente Max. Cabo (Iz)',`${calculos.correnteMaximaCabo.toFixed(2)} A`)}\n`;reportText+=`${formatLine('Potencia Max. Cabo',`${calculos.potenciaMaximaCabo.toFixed(2)} W`)}\n`;reportText+=`\n-- PROTECOES RECOMENDADAS --\n`;reportText+=`${formatLine(`Disjuntor (${dados.tipoDisjuntor})`,`${calculos.disjuntorRecomendado.nome} (Icc: ${calculos.disjuntorRecomendado.icc} kA)`)}\n`;reportText+=`${formatLine('Protecao DR 30mA',dados.requerDR?`Sim (usar ${calculos.disjuntorRecomendado.nome.replace('A','')}A / 30mA)`:'Nao')}\n`;reportText+=`${formatLine('Protecao DPS',dados.classeDPS!=='Nenhum'?`Sim, ${dados.classeDPS} (ex: 20kA)`:'Nao')}\n`;reportText+=`${formatLine('Eletroduto (aprox.)',`${calculos.dutoRecomendado} (${calculos.numCondutores} condutores)`)}\n`});document.getElementById('report').textContent=reportText.trim()}
    function gerarPDF(){const allResults=calcularTodosCircuitos();if(!allResults)return;const{jsPDF}=window.jspdf;const doc=new jsPDF();let yPos=15;doc.setFont('Roboto','normal');const addText=(text,indent=10)=>{if(yPos>280){doc.addPage();yPos=15}
    doc.text(text,indent,yPos);yPos+=5};doc.setFontSize(10);const formatLine=(label,value)=>(label+':').padEnd(20,' ')+(value||'Nao informado');doc.setFont('Roboto','bold');doc.setFontSize(16);doc.text("Relatorio de Projeto Eletrico",105,yPos,{align:'center'});yPos+=10;const dadosCliente=allResults[0].dados;doc.setFont('Roboto','bold');addText("-- DADOS DA OBRA E CLIENTE --");doc.setFont('Roboto','normal');addText(formatLine('Cliente',dadosCliente.cliente));addText(formatLine(`Documento`,`${dadosCliente.tipoDocumento} - ${dadosCliente.documento}`));addText(formatLine('Contato',dadosCliente.celular||dadosCliente.telefone));addText(formatLine('E-mail',dadosCliente.email));addText(formatLine('Obra',dadosCliente.obra));addText(formatLine('Endereco',dadosCliente.endereco));addText(formatLine('Area da Obra',`${dadosCliente.areaObra||'N/A'} m2`));yPos+=5;const respTecnico=document.getElementById('respTecnico').value;const titulo=document.getElementById('titulo').value;const crea=document.getElementById('crea').value;if(respTecnico||titulo||crea){doc.setFont('Roboto','bold');addText("-- RESPONSAVEL TECNICO --");doc.setFont('Roboto','normal');addText(formatLine('Nome',respTecnico));addText(formatLine('Titulo',titulo));addText(formatLine('CREA',crea));yPos+=5}
    const generatingUserName = currentUserProfile?.nome || 'Usuário';
    doc.setFont('Roboto','bold');addText("-- INFORMACOES DO RELATORIO --");doc.setFont('Roboto','normal');addText(formatLine('Gerado em',(new Date).toLocaleString('pt-BR')));addText(formatLine('Gerado por',generatingUserName));yPos+=5;const head=[['Ckt','Nome','Pot.(W)','Tensao(V)','Fases','Cabo','Disjuntor','DR','DPS']];const body=allResults.map(r=>[r.dados.id,r.dados.nomeCircuito,r.calculos.potenciaDemandada.toFixed(2),r.dados.tensaoV,r.dados.fases,r.calculos.bitolaRecomendadaMm2+'mm2',r.calculos.disjuntorRecomendado.nome,r.dados.requerDR?'Sim':'Nao',r.dados.classeDPS]);doc.autoTable({startY:yPos,head:head,body:body,theme:'grid',styles:{font:"Roboto",fontSize:8}});allResults.forEach(result=>{doc.addPage();yPos=15;const{dados,calculos}=result;doc.setFont('Roboto','bold');doc.setFontSize(12);doc.text(`MEMORIAL DE CALCULO - CIRCUITO ${dados.id}: ${dados.nomeCircuito}`,10,yPos);yPos+=10;const addSection=(title,lines)=>{doc.setFont('Roboto','bold');doc.setFontSize(10);addText(title);doc.setFont('Roboto','normal');lines.forEach(line=>addText(line,15))};addSection("-- CARGA E DEMANDA --",[`Potencia Instalada: ${calculos.potenciaInstalada.toFixed(2)} W`,`Corrente Instalada: ${calculos.correnteInstalada.toFixed(2)} A`,`Fator de Demanda: ${dados.fatorDemanda.toFixed(2)}`,`Potencia Demandada: ${calculos.potenciaDemandada.toFixed(2)} W`,`Corrente Demandada (Ib): ${calculos.correnteDemandada.toFixed(2)} A`]);yPos+=3;addSection("-- DIMENSIONAMENTO DO CABO --",[`Material / Isolacao: ${dados.materialCabo} / ${dados.tipoIsolacao}`,`Metodo de Instalacao: ${dados.metodoInstalacao}`,`Fatores de Correcao (K): K1=${calculos.fatorK1.toFixed(2)}, K2=${calculos.fatorK2.toFixed(2)}, K3=${calculos.fatorK3.toFixed(2)}`,`Corrente Corrigida (I'): ${calculos.correnteCorrigidaA.toFixed(2)} A`,`Bitola Recomendada: ${calculos.bitolaRecomendadaMm2} mm2`,`Queda de Tensao (DV): ${calculos.quedaTensaoCalculada.toFixed(2)} % (Limite: ${dados.limiteQuedaTensao.toFixed(2)} %)`]);yPos+=3;addSection("-- PROTECOES RECOMENDADAS --",[`Disjuntor (${dados.tipoDisjuntor}): ${calculos.disjuntorRecomendado.nome} (Icc: ${calculos.disjuntorRecomendado.icc} kA)`,`Corrente Max. Cabo (Iz): ${calculos.correnteMaximaCabo.toFixed(2)} A`,`Protecao DR 30mA: ${dados.requerDR?'Sim':'Nao'}`,`Protecao DPS: ${dados.classeDPS!=='Nenhum'?'Sim, '+dados.classeDPS:'Nao'}`,`Eletroduto (aprox.): ${calculos.dutoRecomendado} (${calculos.numCondutores} condutores)`])});doc.save(`Relatorio_${document.getElementById('obra').value||'Projeto'}.pdf`)}

    // --- FUNÇÕES DE LÓGICA E UI (MODAIS, ETC.) ---
    function openModal(overlayId){document.getElementById(overlayId).style.display='flex'}
    function closeModal(overlayId){document.getElementById(overlayId).style.display='none'}

    // --- FUNÇÕES DE AUTENTICAÇÃO E SESSÃO ---
    async function handleRegister(event) {
        event.preventDefault();
        const nome = document.getElementById('regNome').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const userData = {
            cpf: document.getElementById('regCpf').value,
            telefone: document.getElementById('regTelefone').value,
            crea: document.getElementById('regCrea').value,
            nome: nome
        };

        // 1. Cria o usuário no Supabase Auth
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
        if (authError) {
            alert('Erro ao registrar: ' + authError.message);
            return;
        }

        // 2. Atualiza o perfil do usuário com os dados adicionais
        if (authData.user) {
            const { error: profileError } = await supabaseClient
                .from('profiles')
                .update({ ...userData, updated_at: new Date() })
                .eq('id', authData.user.id);
            
            if (profileError) {
                alert('Erro ao salvar dados do perfil: ' + profileError.message);
            } else {
                alert('Cadastro realizado com sucesso! Aguarde a aprovação de um administrador para fazer login.');
                closeModal('registerModalOverlay');
                document.getElementById('registerForm').reset();
            }
        }
    }

    async function handleLogin() {
        const email = document.getElementById('emailLogin').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!email || !password) return;

        const { data: { user } , error } = await supabaseClient.auth.signInWithPassword({ email, password });

        if (error) {
            alert('Erro no login: ' + error.message);
            return;
        }

        if (user) {
            // Verifica se o usuário está aprovado
            const { data: profile, error: profileError } = await supabaseClient
                .from('profiles')
                .select('is_approved')
                .eq('id', user.id)
                .single();

            if (profileError) {
                alert("Não foi possível verificar seu perfil. Tente novamente.");
                handleLogout(); // Desloga por segurança
                return;
            }

            if (profile && profile.is_approved) {
                await showApp(); // A função showApp vai buscar os dados novamente
            } else {
                alert('Seu acesso ainda não foi aprovado por um administrador.');
                handleLogout();
            }
        }
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        currentUserProfile = null;
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('adminPanelBtn').style.display = 'none';
        document.getElementById('manageProjectsBtn').style.display = 'none';
    }

    async function showApp() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';

        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !data) {
                alert('Não foi possível carregar o perfil do usuário.');
                handleLogout();
                return;
            }
            currentUserProfile = data;
            const isAdmin = currentUserProfile.is_admin;
            document.getElementById('adminPanelBtn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('manageProjectsBtn').style.display = isAdmin ? 'block' : 'none';
            resetForm(true);
        } else {
            handleLogout();
        }
    }

    // --- FUNÇÕES DE GERENCIAMENTO DE PROJETOS ---
    function resetForm(addFirstCircuit = false) {
        document.getElementById('main-form').reset();
        document.getElementById('tech-form').reset();
        document.getElementById('currentProjectId').value = '';
        circuitsContainer.innerHTML = '';
        circuitCount = 0;
        if (addFirstCircuit) addCircuit();
        document.getElementById('report').textContent = 'O relatório aparecerá aqui.';
        document.getElementById('searchInput').value = '';
        loadProjectList();
    }

    async function loadProjectList(searchTerm = '') {
        const select = document.getElementById('savedProjectsSelect');
        select.innerHTML = '<option value="">-- Selecione uma obra --</option>';

        let query = supabaseClient.from('projects').select('id, project_name, owner_id, profiles(nome)');

        // Se não for admin, a política RLS já filtra. Para admin, não precisa de filtro extra.
        if (searchTerm) {
            query = query.ilike('project_name', `%${searchTerm}%`);
        }
        
        const { data: projects, error } = await query.order('project_name');

        if (error) {
            console.error('Erro ao carregar projetos:', error);
            return;
        }

        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.project_name;
             if (currentUserProfile.is_admin) {
                option.textContent += ` (${project.profiles?.nome || 'Desconhecido'})`;
            }
            select.appendChild(option);
        });
    }

    async function handleSaveProject() {
        const projectName = document.getElementById('obra').value.trim();
        if (!projectName) {
            alert("Por favor, insira um 'Nome da Obra' para salvar.");
            return;
        }

        const mainData = {};
        document.querySelectorAll('#main-form input, #main-form select').forEach(el => mainData[el.id] = el.value);
        
        const techData = {};
        document.querySelectorAll('#tech-form input').forEach(el => techData[el.id] = el.value);
        
        const circuitsData = [];
        document.querySelectorAll('.circuit-block').forEach(block => {
            const circuit = { id: block.dataset.id };
            block.querySelectorAll('input, select').forEach(el => {
                circuit[el.id] = el.type === 'checkbox' ? el.checked : el.value;
            });
            circuitsData.push(circuit);
        });
        
        const projectData = {
            project_name: projectName,
            main_data: mainData,
            tech_data: techData,
            circuits_data: circuitsData,
            owner_id: currentUserProfile.id
        };
        
        const currentProjectId = document.getElementById('currentProjectId').value;
        let result;

        if (currentProjectId) {
            // Atualiza projeto existente
            result = await supabaseClient.from('projects').update(projectData).eq('id', currentProjectId).select().single();
        } else {
             // Cria um novo código de cliente se necessário
            if (!mainData.codigoCliente) {
                const { count, error: countError } = await supabaseClient.from('projects').select('*', { count: 'exact', head: true });
                if (countError) { alert('Erro ao gerar código do cliente'); return; }
                projectData.main_data.codigoCliente = 'C-' + String(count + 1).padStart(3, '0');
                document.getElementById('codigoCliente').value = projectData.main_data.codigoCliente;
            }
            // Insere novo projeto
            result = await supabaseClient.from('projects').insert(projectData).select().single();
        }

        const { data, error } = result;

        if (error) {
            alert('Erro ao salvar obra: ' + error.message);
        } else {
            alert(`Obra "${projectName}" salva com sucesso!`);
            document.getElementById('currentProjectId').value = data.id;
            loadProjectList();
        }
    }

    async function handleLoadProject() {
        const projectId = document.getElementById('savedProjectsSelect').value;
        if (!projectId) return;

        const { data: projectData, error } = await supabaseClient
            .from('projects')
            .select('*')
            .eq('id', projectId)
            .single();

        if (error || !projectData) {
            alert('Erro ao carregar a obra.');
            return;
        }

        resetForm(false); // Limpa o formulário sem adicionar circuito inicial

        document.getElementById('currentProjectId').value = projectData.id;
        Object.keys(projectData.main_data).forEach(id => {
            if (document.getElementById(id)) document.getElementById(id).value = projectData.main_data[id];
        });
        Object.keys(projectData.tech_data).forEach(id => {
            if (document.getElementById(id)) document.getElementById(id).value = projectData.tech_data[id];
        });
        
        projectData.circuits_data.forEach(savedCircuitData => {
            addCircuit();
            const currentId = circuitCount;
            Object.keys(savedCircuitData).forEach(savedId => {
                if(savedId === 'id') return;
                const newId = savedId.replace(`-${savedCircuitData.id}`, `-${currentId}`);
                const element = document.getElementById(newId);
                if (element) {
                    if (element.type === 'checkbox') element.checked = savedCircuitData[savedId];
                    else element.value = savedCircuitData[savedId];
                }
            });
            document.getElementById(`fases-${currentId}`).dispatchEvent(new Event('change'));
            document.getElementById(`tipoLigacao-${currentId}`).value = savedCircuitData[`tipoLigacao-${savedCircuitData.id}`];
            document.getElementById(`tipoCircuito-${currentId}`).dispatchEvent(new Event('change'));
        });
        
        alert(`Obra "${projectData.project_name}" carregada.`);
    }

    async function handleDeleteProject() {
        const projectId = document.getElementById('savedProjectsSelect').value;
        const projectName = document.getElementById('savedProjectsSelect').options[document.getElementById('savedProjectsSelect').selectedIndex].text;
        if (!projectId) {
            alert("Selecione uma obra para excluir.");
            return;
        }

        if (confirm(`Tem certeza que deseja excluir a obra "${projectName}"?`)) {
            const { error } = await supabaseClient.from('projects').delete().eq('id', projectId);
            if (error) {
                alert('Erro ao excluir obra: ' + error.message);
            } else {
                alert("Obra excluída.");
                resetForm(true);
            }
        }
    }

    function handleNewProject() {
        if (confirm("Deseja limpar todos os campos para iniciar uma nova obra?")) {
            resetForm(true);
        }
    }

    // --- FUNÇÕES DE ADMINISTRAÇÃO ---
    async function populateUsersPanel() {
        const { data: users, error } = await supabaseClient.from('profiles').select('*').order('nome');
        if (error) { alert("Erro ao buscar usuários."); return; }
        
        const userList = document.getElementById('adminUserList');
        userList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            let actions = '';
            if (user.is_approved) {
                 actions = `<button class="edit-user-btn" data-user-id="${user.id}">Editar</button>
                            <button class="remove-user-btn" data-user-id="${user.id}">Remover</button>`;
            } else {
                actions = `<button class="approve-user-btn" data-user-id="${user.id}">Aprovar</button>`;
            }
            li.innerHTML = `<span>${user.nome || user.email} ${user.is_approved ? '' : '(Pendente)'}</span><div class="admin-user-actions">${actions}</div>`;
            userList.appendChild(li);
        });
    }

    async function handleApproveUser(userId) {
        const { error } = await supabaseClient.from('profiles').update({ is_approved: true }).eq('id', userId);
        if (error) { alert("Erro ao aprovar usuário."); } else { alert("Usuário aprovado!"); populateUsersPanel(); }
    }
    
    function handleRemoveUser(userId) {
        // A remoção de usuários do `auth.users` deve ser feita no backend (Edge Function) por segurança.
        // O código abaixo removeria apenas o perfil, deixando o login órfão.
        // É uma limitação de segurança do Supabase no lado do cliente.
        alert("A remoção de usuários deve ser implementada via Supabase Edge Function por razões de segurança. Esta função está desabilitada na interface.");
        // Exemplo de como seria (se fosse seguro):
        // if (confirm("Tem certeza? Isso removerá o perfil do usuário, mas não o login.")) {
        //     const { error } = await supabaseClient.from('profiles').delete().eq('id', userId);
        //     if (error) { alert("Erro."); } else { alert("Perfil removido."); populateUsersPanel(); }
        // }
    }

    async function openEditUserModal(userId) {
        const { data: userData, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
        if (error || !userData) { alert("Usuário não encontrado."); return; }
        
        document.getElementById('editUserId').value = userData.id;
        document.getElementById('editNome').value = userData.nome;
        document.getElementById('editCpf').value = userData.cpf;
        document.getElementById('editTelefone').value = userData.telefone;
        document.getElementById('editEmail').value = userData.email;
        document.getElementById('editCrea').value = userData.crea;
        openModal('editUserModalOverlay');
    }

    async function handleUpdateUser(event) {
        event.preventDefault();
        const userId = document.getElementById('editUserId').value;
        const updatedData = {
            nome: document.getElementById('editNome').value,
            cpf: document.getElementById('editCpf').value,
            telefone: document.getElementById('editTelefone').value,
            email: document.getElementById('editEmail').value,
            crea: document.getElementById('editCrea').value,
        };
        
        const { error } = await supabaseClient.from('profiles').update(updatedData).eq('id', userId);
        
        if (error) {
            alert("Erro ao atualizar dados: " + error.message);
        } else {
            alert("Dados do usuário atualizados com sucesso!");
            closeModal('editUserModalOverlay');
            populateUsersPanel();
        }
    }

    async function populateProjectsPanel() {
        const { data: projects, error: pError } = await supabaseClient.from('projects').select('id, project_name, owner_id, profiles(nome)');
        const { data: users, error: uError } = await supabaseClient.from('profiles').select('id, nome').eq('is_approved', true);
        if (pError || uError) { alert("Erro ao carregar dados."); return; }

        const tableBody = document.getElementById('adminProjectsTableBody');
        tableBody.innerHTML = '';
        projects.forEach(project => {
            const row = document.createElement('tr');
            const userOptions = users.map(user => `<option value="${user.id}" ${user.id === project.owner_id ? 'selected' : ''}>${user.nome}</option>`).join('');
            row.innerHTML = `
                <td>${project.project_name}</td>
                <td>${project.profiles?.nome || 'Desconhecido'}</td>
                <td>
                    <select>${userOptions}</select>
                    <button class="transfer-btn" data-project-id="${project.id}">Transferir</button>
                </td>`;
            tableBody.appendChild(row);
        });
    }

    async function handleTransferProject(projectId, newOwnerId) {
        if (confirm(`Deseja transferir esta obra?`)) {
            const { error } = await supabaseClient.from('projects').update({ owner_id: newOwnerId }).eq('id', projectId);
            if (error) {
                alert("Erro ao transferir: " + error.message);
            } else {
                alert("Obra transferida com sucesso!");
                populateProjectsPanel();
            }
        }
    }

    // --- INICIALIZAÇÃO DA APLICAÇÃO E LISTENERS ---
    document.addEventListener('DOMContentLoaded', function() {
        // Autenticação e Modais
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('registerBtn').addEventListener('click', () => openModal('registerModalOverlay'));
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay').id)));

        // Ações de Projeto
        document.getElementById('saveBtn').addEventListener('click', handleSaveProject);
        document.getElementById('loadBtn').addEventListener('click', handleLoadProject);
        document.getElementById('deleteBtn').addEventListener('click', handleDeleteProject);
        document.getElementById('newBtn').addEventListener('click', handleNewProject);
        document.getElementById('searchInput').addEventListener('input', (e) => loadProjectList(e.target.value));
        
        // Ações de Cálculo e PDF
        document.getElementById('calculateBtn').addEventListener('click', calcularTodosCircuitos);
        document.getElementById('pdfBtn').addEventListener('click', gerarPDF);

        // Ações de Circuito
        document.getElementById('addCircuitBtn').addEventListener('click', addCircuit);
        circuitsContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-btn')) removeCircuit(e.target.dataset.circuitId); });

        // Admin
        document.getElementById('adminPanelBtn').addEventListener('click', () => { populateUsersPanel(); openModal('adminPanelModalOverlay'); });
        document.getElementById('manageProjectsBtn').addEventListener('click', () => { populateProjectsPanel(); openModal('manageProjectsModalOverlay'); });
        document.getElementById('editUserForm').addEventListener('submit', handleUpdateUser);
        document.getElementById('adminUserList').addEventListener('click', (event) => {
            const target = event.target;
            const userId = target.dataset.userId;
            if (target.classList.contains('remove-user-btn')) { handleRemoveUser(userId); }
            if (target.classList.contains('edit-user-btn')) { openEditUserModal(userId); }
            if (target.classList.contains('approve-user-btn')) { handleApproveUser(userId); }
        });
        document.getElementById('adminProjectsTableBody').addEventListener('click', (event) => {
            if (event.target.classList.contains('transfer-btn')) {
                const button = event.target;
                const projectId = button.dataset.projectId;
                const newOwnerId = button.previousElementSibling.value;
                handleTransferProject(projectId, newOwnerId);
            }
        });

        // Máscaras de Input
        document.getElementById('regCpf').addEventListener('input', mascaraCPF);
        document.getElementById('regTelefone').addEventListener('input', mascaraCelular);
        document.getElementById('editCpf').addEventListener('input', mascaraCPF);
        document.getElementById('editTelefone').addEventListener('input', mascaraCelular);
        document.getElementById('tipoDocumento').addEventListener('change', atualizarMascaraDocumento);
        document.getElementById('documento').addEventListener('input', aplicarMascara);
        document.getElementById('telefone').addEventListener('input', mascaraTelefone);
        document.getElementById('celular').addEventListener('input', mascaraCelular);

        // Verifica a sessão ao carregar a página
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                showApp();
            }
        });
        
        atualizarMascaraDocumento();
    });
</script>